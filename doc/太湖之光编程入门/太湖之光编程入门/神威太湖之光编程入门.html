<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>神威太湖之光编程入门.md</title><link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css'><style type='text/css'>html, body {overflow-x: initial !important;}.CodeMirror { height: auto; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; }
.CodeMirror-lines { padding: 4px 0px; }
.CodeMirror pre { }
.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { background-color: white; }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background-color: rgb(247, 247, 247); white-space: nowrap; }
.CodeMirror-linenumbers { }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.CodeMirror div.CodeMirror-cursor { border-left: 1px solid black; z-index: 3; }
.CodeMirror div.CodeMirror-secondarycursor { border-left: 1px solid silver; }
.CodeMirror.cm-keymap-fat-cursor div.CodeMirror-cursor { width: auto; border: 0px; background: rgb(119, 238, 119); z-index: 1; }
.CodeMirror div.CodeMirror-cursor.CodeMirror-overwrite { }
.cm-tab { display: inline-block; }
.cm-s-typora-default .cm-header, .cm-s-typora-default .cm-property { color: rgb(217, 79, 138); }
.cm-s-typora-default pre.cm-header1:not(.cm-atom) :not(.cm-overlay) { font-size: 2rem; line-height: 2rem; }
.cm-s-typora-default pre.cm-header2:not(.cm-atom) :not(.cm-overlay) { font-size: 1.4rem; line-height: 1.4rem; }
.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number { color: rgb(149, 132, 134); }
.cm-s-typora-default .cm-table-row, .cm-s-typora-default .cm-block-start { font-family: monospace; }
.cm-s-typora-default .cm-comment, .cm-s-typora-default .cm-code { color: rgb(74, 90, 159); font-family: monospace; }
.cm-s-typora-default .cm-tag { color: rgb(169, 68, 66); }
.cm-s-typora-default .cm-string { color: rgb(126, 134, 169); }
.cm-s-typora-default .cm-link { color: rgb(196, 122, 15); text-decoration: underline; }
.cm-s-typora-default .cm-variable-2, .cm-s-typora-default .cm-variable-1 { color: inherit; }
.cm-s-typora-default .cm-overlay { font-size: 1rem; font-family: monospace; }
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor { border-left: 3px solid rgb(228, 98, 154); }
.cm-s-typora-default .CodeMirror-activeline-background { left: -60px; right: -30px; background: rgba(204, 204, 204, 0.2); }
.cm-s-typora-default .CodeMirror-gutters { border-right: none; background-color: inherit; }
.cm-s-typora-default .cm-trailing-space-new-line::after, .cm-startspace::after, .cm-starttab .cm-tab::after { content: "•"; position: absolute; left: 0px; opacity: 0; font-family: LetterGothicStd, monospace; }
.os-windows .cm-startspace::after, .os-windows .cm-starttab .cm-tab::after { left: -0.1em; }
.cm-starttab .cm-tab::after { content: " "; }
.cm-startspace, .cm-tab, .cm-starttab, .cm-trailing-space-a, .cm-trailing-space-b, .cm-trailing-space-new-line { font-family: monospace; position: relative; }
.cm-s-typora-default .cm-trailing-space-new-line::after { content: "↓"; opacity: 0.3; }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: black; }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-property { color: black; }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: blue; }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: bold; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: rgb(255, 0, 0); }
.cm-invalidchar { color: rgb(255, 0, 0); }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { margin-bottom: -30px; margin-right: -30px; padding-bottom: 30px; padding-right: 30px; height: 100%; outline: none; position: relative; box-sizing: content-box; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow-x: hidden; overflow-y: scroll; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow-y: hidden; overflow-x: scroll; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: transparent; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-widget { }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.CodeMirror-selected { background: rgb(217, 217, 217); }
.CodeMirror-focused .CodeMirror-selected { background: rgb(215, 212, 240); }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
.CodeMirror span { }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}
.CodeMirror-lint-markers { width: 16px; }
.CodeMirror-lint-tooltip { background-color: infobackground; border: 1px solid black; border-radius: 4px; color: infotext; font-family: monospace; overflow: hidden; padding: 2px 5px; position: fixed; white-space: pre-wrap; z-index: 10000; max-width: 600px; opacity: 0; transition: opacity 0.4s; font-size: 0.8em; }
.CodeMirror-lint-mark-error, .CodeMirror-lint-mark-warning { background-position: left bottom; background-repeat: repeat-x; }
.CodeMirror-lint-mark-error { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg=="); }
.CodeMirror-lint-marker-error, .CodeMirror-lint-marker-warning { background-position: center center; background-repeat: no-repeat; cursor: pointer; display: inline-block; height: 16px; width: 16px; vertical-align: middle; position: relative; }
.CodeMirror-lint-message-error, .CodeMirror-lint-message-warning { padding-left: 18px; background-position: left top; background-repeat: no-repeat; }
.CodeMirror-lint-marker-error, .CodeMirror-lint-message-error { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII="); }
.CodeMirror-lint-marker-warning, .CodeMirror-lint-message-warning { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII="); }
.CodeMirror-lint-marker-multiple { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC"); background-repeat: no-repeat; background-position: right bottom; width: 100%; height: 100%; }


html { font-size: 14px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { background: rgb(181, 214, 252); text-shadow: none; }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; padding-bottom: 70px; white-space: pre-wrap; overflow-x: auto; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
.typora-export #write { margin: 0px auto; }
#write > p:first-child, #write > ul:first-child, #write > ol:first-child, #write > pre:first-child, #write > blockquote:first-child, #write > div:first-child, #write > table:first-child { margin-top: 30px; }
#write li > table:first-child { margin-top: -20px; }
img { max-width: 100%; vertical-align: middle; }
input, button, select, textarea { color: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
::before, ::after, * { box-sizing: border-box; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write div, #write pre { width: inherit; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6 { position: relative; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
p { -webkit-margin-before: 1rem; -webkit-margin-after: 1rem; -webkit-margin-start: 0px; -webkit-margin-end: 0px; }
.mathjax-block { margin-top: 0px; margin-bottom: 0px; -webkit-margin-before: 0rem; -webkit-margin-after: 0rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: bold; font-style: italic; }
a { cursor: pointer; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; margin: 4px 0px 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 80px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
pre { white-space: pre-wrap; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
.md-fences .CodeMirror.CodeMirror-wrap { top: -1.6em; margin-bottom: -1.6em; }
.md-fences.mock-cm { white-space: pre-wrap; }
.show-fences-line-number .md-fences { padding-left: 0px; }
.show-fences-line-number .md-fences.mock-cm { padding-left: 40px; }
.footnotes { opacity: 0.8; font-size: 0.9rem; padding-top: 1em; padding-bottom: 1em; }
.footnotes + .footnotes { margin-top: -1em; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: transparent; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: normal; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li p, li .mathjax-block { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; }
@media print { 
  html, body { height: 100%; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  h1, h2, h3, h4, h5, h6 { break-after: avoid-page; orphans: 2; }
  p { orphans: 4; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 1cm; padding-right: 1cm; }
  .typora-export #write::after { height: 0px; }
  @page { margin: 20mm 0mm; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 2.86rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p .md-image:only-child { display: inline-block; width: 100%; text-align: center; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.mathjax-block { white-space: pre; overflow: hidden; width: 100%; }
p + .mathjax-block { margin-top: -1.143rem; }
.mathjax-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: none; box-shadow: none; }
.task-list { list-style-type: none; }
.task-list-item { position: relative; padding-left: 1em; }
.task-list-item input { position: absolute; top: 0px; left: 0px; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc::after, .md-toc-content::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); text-decoration: none; }
.md-toc-inner:hover { }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: bold; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
.md-tag { opacity: 0.5; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: monospace; }
code { text-align: left; }
h1 .md-tag, h2 .md-tag, h3 .md-tag, h4 .md-tag, h5 .md-tag, h6 .md-tag { font-weight: initial; opacity: 0.35; }
a.md-print-anchor { border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: none !important; background: transparent !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.mathjax-block .MathJax_SVG_Display { text-align: center; margin: 1em 0em; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: monospace; }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: normal; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }


@font-face { font-family: "Open Sans"; font-style: normal; font-weight: normal; src: local("Open Sans Regular"), url("./github/400.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: italic; font-weight: normal; src: local("Open Sans Italic"), url("./github/400i.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: normal; font-weight: bold; src: local("Open Sans Bold"), url("./github/700.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: italic; font-weight: bold; src: local("Open Sans Bold Italic"), url("./github/700i.woff") format("woff"); }
html { font-size: 16px; }
body { font-family: "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; color: rgb(51, 51, 51); line-height: 1.6; }
#write { max-width: 860px; margin: 0px auto; padding: 20px 30px 100px; }
#write > ul:first-child, #write > ol:first-child { margin-top: 30px; }
body > :first-child { margin-top: 0px !important; }
body > :last-child { margin-bottom: 0px !important; }
a { color: rgb(65, 131, 196); }
h1, h2, h3, h4, h5, h6 { position: relative; margin-top: 1rem; margin-bottom: 1rem; font-weight: bold; line-height: 1.4; cursor: text; }
h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor { text-decoration: none; }
h1 tt, h1 code { font-size: inherit; }
h2 tt, h2 code { font-size: inherit; }
h3 tt, h3 code { font-size: inherit; }
h4 tt, h4 code { font-size: inherit; }
h5 tt, h5 code { font-size: inherit; }
h6 tt, h6 code { font-size: inherit; }
h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom: 1px solid rgb(238, 238, 238); }
h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom: 1px solid rgb(238, 238, 238); }
h3 { font-size: 1.5em; line-height: 1.43; }
h4 { font-size: 1.25em; }
h5 { font-size: 1em; }
h6 { font-size: 1em; color: rgb(119, 119, 119); }
p, blockquote, ul, ol, dl, table { margin: 0.8em 0px; }
li > ol, li > ul { margin: 0px; }
hr { height: 4px; padding: 0px; margin: 16px 0px; background-color: rgb(231, 231, 231); border-width: 0px 0px 1px; border-style: none none solid; border-top-color: initial; border-right-color: initial; border-left-color: initial; border-image: initial; overflow: hidden; box-sizing: content-box; border-bottom-color: rgb(221, 221, 221); }
body > h2:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child + h2 { margin-top: 0px; padding-top: 0px; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child { margin-top: 0px; padding-top: 0px; }
a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 { margin-top: 0px; padding-top: 0px; }
h1 p, h2 p, h3 p, h4 p, h5 p, h6 p { margin-top: 0px; }
li p.first { display: inline-block; }
ul, ol { padding-left: 30px; }
ul:first-child, ol:first-child { margin-top: 0px; }
ul:last-child, ol:last-child { margin-bottom: 0px; }
blockquote { border-left: 4px solid rgb(221, 221, 221); padding: 0px 15px; color: rgb(119, 119, 119); }
blockquote blockquote { padding-right: 0px; }
table { padding: 0px; word-break: initial; }
#write { overflow-x: auto; }
table tr { border-top: 1px solid rgb(204, 204, 204); background-color: white; margin: 0px; padding: 0px; }
table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
table tr th { font-weight: bold; border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr td { border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr th:first-child, table tr td:first-child { margin-top: 0px; }
table tr th:last-child, table tr td:last-child { margin-bottom: 0px; }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); }
.md-fences, code, tt { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); border-radius: 3px; font-family: Consolas, "Liberation Mono", Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; }
.md-fences { margin-bottom: 15px; margin-top: 15px; padding: 8px 1em 6px; }
.task-list { padding-left: 0px; }
.task-list-item { padding-left: 32px; }
.task-list-item input { top: 3px; left: 8px; }
@media screen and (min-width: 914px) { 
}
@media print { 
  html { font-size: 13px; }
  table, pre { break-inside: avoid; }
  pre { word-wrap: break-word; }
}
.md-fences { background-color: rgb(248, 248, 248); }
#write pre.md-meta-block { padding: 1rem; font-size: 85%; line-height: 1.45; background-color: rgb(247, 247, 247); border: 0px; border-radius: 3px; color: rgb(119, 119, 119); margin-top: 0px !important; }
.mathjax-block > .code-tooltip { bottom: 0.375rem; }
#write > h3.md-focus::before { left: -1.5625rem; top: 0.375rem; }
#write > h4.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h5.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h6.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
.md-image > .md-meta { border: 1px solid rgb(221, 221, 221); border-radius: 3px; font-family: Consolas, "Liberation Mono", Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; color: inherit; }
.md-tag { color: inherit; }
.md-toc { margin-top: 20px; padding-bottom: 20px; }
#typora-quick-open { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); }
#typora-quick-open-item { background-color: rgb(250, 250, 250); border-color: rgb(254, 254, 254) rgb(229, 229, 229) rgb(229, 229, 229) rgb(238, 238, 238); border-style: solid; border-width: 1px; }
#md-notification::before { top: 10px; }
.on-focus-mode blockquote { border-left-color: rgba(85, 85, 85, 0.117647); }
header, .context-menu, .megamenu-content, footer { font-family: "Segoe UI", Arial, sans-serif; }






</style>
</head>
<body class='typora-export' >
<div  id='write'  class = 'is-node'><h1><a name='header-c1' class='md-header-anchor '></a>神威太湖之光编程入门</h1><p>作者：黄承欢 </p><p>文档整理：黄华</p><p><strong>使用前请注意：</strong> </p><ul><li><strong>本文件不能替代官方资料，请务必以官方资料作为编程指导标准。</strong> </li><li><strong>本文件中部分信息是基于实验得出的总结，未必完全准确，也未必在官方资料中出现。</strong></li><li><strong>本文件仅供内部参考，请注意保管。</strong></li></ul><h2><a name='header-c21' class='md-header-anchor '></a>系统基本信息</h2><h3><a name='header-c22' class='md-header-anchor '></a>系统架构</h3><p>SW26010 每一个计算节点有四个核组（CG, Core Group），每个核组有 64 个 SW3 架构的 CPE (Computing Processing Element) 和 1 个 SW5 架构的 MPE(Management Processing Element)。下面是一个计算节点的结构简图：</p><p><img src='./images/SW_node_arch.png' alt='SW26010 Arch' /></p><p>每一个 CPE （俗称『从核』）有 16KB 指令 L1 和 64KB LDM (Local Data Memory, a.k.a SPM, Scratch Pad Memory) ，无数据 L1，cache line 大小 32 Bytes，运行在 1.45 GHz 的固定频率。</p><p>每一个 MPE （俗称『主核』）有 32KB 数据 + 32KB 指令 L1，256KB 数据 L2，cache line 大小 128 Bytes，运行在 1.45 GHz 的固定频率。</p><p>每一个 CG 有 64 个 CPE 和一个 MPE，以及 8GB DDR3 内存。四个 CG 通过片上网络（NoC, Network on Chip）进行互联。</p><p>神威太湖之光每块电路板（Card）上有 2 个节点。每个支撑板（Board）上有 4 块电路板。每个超节点（Super Node）有 32 个支撑板，32 个支撑板里的 256 个计算节点是全连接的。每个机舱（Cabinet）有4个超节点。</p><h3><a name='header-c35' class='md-header-anchor '></a>系统时延</h3><p>经查资料和测试，已知以下操作的时延：</p><table><thead><tr><th>项目</th><th>所需 cycle 数</th></tr></thead><tbody><tr><td>整数位运算</td><td>1</td></tr><tr><td>MPE &lt;--&gt; MPE L1 Data Cache</td><td>4</td></tr><tr><td>CPE &lt;--&gt; SPM</td><td>4</td></tr><tr><td>普通浮点运算</td><td>7</td></tr><tr><td>MPE L1 Data Cache &lt;--&gt; MPE L2 Data Cache</td><td>13</td></tr><tr><td>SPM &lt;--(DMA)--&gt; DDR3 Memory</td><td>~25</td></tr><tr><td>浮点开平方</td><td>29</td></tr><tr><td>浮点除法</td><td>31</td></tr><tr><td>SPM &lt;--(gld/gst)--&gt; DDR3 Memory</td><td>278</td></tr><tr><td>主核从核实时交互</td><td>~750</td></tr><tr><td>MPI_Sendrecv ping-pong</td><td>~7000</td></tr><tr><td>athread_spawn / athread_join</td><td>~22730</td></tr></tbody></table><p>测试 FMA 时延的代码请参见 <code>./test_fma_cycle</code> 文件夹。有一些函数的时延不是很好测试，比如位操作和选择操作的时延，主要是由于编译器优化。</p><h2><a name='header-c82' class='md-header-anchor '></a>使用从核加速</h2><p>SW26010 的主要计算力量来自从核。要使用从核，必须使用 athread 库（Accelerating THREAD），并且分别为主核和从核编写不同的代码，使用不同的参数和编译器来编译。</p><h3><a name='header-c85' class='md-header-anchor '></a>基本框架</h3><p>一个主核代码文件一般会包含以下几条语句：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure">AخA</div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;athread.h&gt; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="cm-comment">// 使用 athread</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_init</span>(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-comment">// 初始化核组</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_spawn</span>(<span class="cm-variable">func</span>, <span class="cm-variable">param</span>);  <span class="cm-comment">// 启动从核核组，一般是 64 条线程，目标函数是 slave_func</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_join</span>(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-comment">// 等待从核核组全部执行完毕</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>一个从核代码文件一般会包含以下几条语句：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;slave.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">slave_func</span>(<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">param</span>)  <span class="cm-comment">// 从核计算函数，将会被主核调用</span></span></pre><pre class=""><span style="padding-right: 0.1px;">{ <span class="cm-comment">/* other codes */</span> }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other functions and codes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p>一个简单的 Makefile 文件如下：</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">EXE<span class="cm-tab"> </span><span class="cm-operator">=</span> test</span></pre></div><pre class=""><span style="padding-right: 0.1px;">CC<span class="cm-tab">  </span><span class="cm-operator">=</span> mpicc</span></pre><pre class=""><span style="padding-right: 0.1px;">SCC<span class="cm-tab"> </span><span class="cm-operator">=</span> sw5cc</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -msimd 允许程序使用 SIMD 向量化， -std=gnu99 允许程序使用 for (int i = ...) 这样的语法糖</span></span></pre><pre class=""><span style="padding-right: 0.1px;">HFLAGS<span class="cm-tab">  </span><span class="cm-operator">=</span> <span class="cm-attribute">-host</span>  <span class="cm-attribute">-std</span><span class="cm-operator">=</span>gnu99 <span class="cm-attribute">-O2</span> <span class="cm-attribute">-msimd</span> <span class="cm-comment"># 主核文件编译可以不加 -host</span></span></pre><pre class=""><span style="padding-right: 0.1px;">SFLAGS<span class="cm-tab">  </span><span class="cm-operator">=</span> <span class="cm-attribute">-slave</span> <span class="cm-attribute">-std</span><span class="cm-operator">=</span>gnu99 <span class="cm-attribute">-O2</span> <span class="cm-attribute">-msimd</span> <span class="cm-comment"># 从核文件编译必须加上 -slave</span></span></pre><pre class=""><span style="padding-right: 0.1px;">LDFLAGS<span class="cm-tab"> </span><span class="cm-operator">=</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-quote">$(EXE)</span>:host.o slave.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-quote">$(CC)</span> <span class="cm-quote">$(LDFLAGS)</span> *.o <span class="cm-attribute">-o</span> <span class="cm-def">$@</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">host.o: host.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-quote">$(CC)</span> <span class="cm-attribute">-c</span> <span class="cm-quote">$(HFLAGS)</span> host.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">slave.o: slave.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-quote">$(SCC)</span> <span class="cm-attribute">-c</span> <span class="cm-quote">$(SFLAGS)</span> slave.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">clean:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">rm</span> *.o</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 434px;"></div></div></div></pre><p>在官方的《基础语言编译手册》（2016年8月1日版，下同）中，有这么一句话：</p><blockquote><p> 主核代码以 text 为段名，从核代码以 text1 为段名。对位于从核 text1 段中的从核程序，编译器和底层工具链会自动对函数增加”slave<em>”前缀，如函数 func()会自动换名为 slave_func()。用户已经手工添加 slave</em>前缀的则不再重复添加。</p></blockquote><p>也就是说，从核代码文件里的函数要被主核调用，有以下两种方式：</p><p>第一种：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* slave.c */</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;slave.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "my_slave.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">slave_func</span>(<span class="cm-variable">coid</span> <span class="cm-operator">*</span><span class="cm-variable">param</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* my_slave.h */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#ifndef MY_SLAVE_H</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define MY_SLAVE_H</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">slave_func</span>(<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">param</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other interfaces</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#endif</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* host.c */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "my_slave.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_spawn</span>(<span class="cm-variable">func</span>, <span class="cm-variable">param</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_join</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p>注意，编译器里已经有一个 <code>slave.h</code>，从核程序需要 <code>#include &lt;slave.h&gt;</code>。因此，我们自己写头文件不能和这个重名。</p><p>第二种方式，使用 <code>SLAVE_FUN(&lt;SLAVE_FUNC_NAME&gt;)();</code> 来告诉编译器：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* slave.c */</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;slave.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">func</span>(<span class="cm-variable">coid</span> <span class="cm-operator">*</span><span class="cm-variable">param</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* my_slave.h */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#ifndef MY_SLAVE_H</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define MY_SLAVE_H</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">func</span>(<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">param</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other interfaces</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#endif</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/* host.c */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "my_slave.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">SLAVE_FUN</span>(<span class="cm-variable">func</span>)();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_spawn</span>(<span class="cm-variable">func</span>, <span class="cm-variable">param</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_join</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// other codes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 448px;"></div></div></div></pre><p>一个简单的 Hello World Demo 在<code>./hello_world_demo</code> 文件夹中。其中，<code>host.c</code> 定义的 <code>rpcc()</code> 用于取得当前 CPU 的 cycle 计数，两次 <code>rpcc()</code>  结果之差即为它们中间的代码运行所消耗的墙钟 cycle 数，此值除以 1450000000 即可得到秒数。</p><p>如果从核函数有多个参数需要输入，则需要先定义一个 struct 来保存所有的输入参数，再将此 struct 的指针作为参数传给从核函数，和 pthread 的做法一样。一个 daxpy demo 在 <code>./demo_daxpy</code> 文件夹中，包含了此操作。也有一种比较偷懒的做法，即在从核代码文件中使用 <code>extern</code> 关键字，在主核代码文件中使用全局变量。这样的坏处是不利于组织大型的代码工程。</p><h3><a name='header-c114' class='md-header-anchor '></a>从核间同步</h3><p>从核之间的同步需要通过 <code>athread_sync()</code> 函数来进行，支持行同步、列同步和核组同步：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">total_mask</span> <span class="cm-operator">=</span> <span class="cm-number">0x0000FFFF</span>; &nbsp; <span class="cm-comment">// 低 16 位有效</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">row_mask</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">0x000000FF</span>; &nbsp; <span class="cm-comment">// 低 8 位有效</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">col_mask</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">0x000000FF</span>; &nbsp; <span class="cm-comment">// 低 8 位有效</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_syn</span>(<span class="cm-variable">ARRAY_SCOPE</span>, <span class="cm-variable">total_mask</span>);  <span class="cm-comment">// 全核组同步</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_syn</span>(<span class="cm-variable">ROW_SCOPE</span>, <span class="cm-variable">row_mask</span>); &nbsp; &nbsp;  <span class="cm-comment">// 所有 8 行进行行同步</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_syn</span>(<span class="cm-variable">COL_SCOPE</span>, <span class="cm-variable">col_mask</span>); &nbsp; &nbsp;  <span class="cm-comment">// 所有 8 列进行列同步</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><h3><a name='header-c118' class='md-header-anchor '></a>从核间通信</h3><p>每一个核组的 64 个从核排列成 8 * 8 的二维 mesh，每一行和每一列的从核都有共享的寄存器，可以使用这些寄存器来进行通信。SWCC 提供四个宏来进行操作，如果将其视为函数，那么这四个函数的接口如下：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">simd_type</span> <span class="cm-def">simd_getc</span>(<span class="cm-variable">simd_type</span> <span class="cm-variable">val</span>); &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-comment">// 从核接收所在列的通信信息</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">simd_type</span> <span class="cm-def">simd_getr</span>(<span class="cm-variable">simd_type</span> <span class="cm-variable">val</span>); &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-comment">// 从核接收所在行的通信信息</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">simd_putc</span>(<span class="cm-variable">simd_type</span> <span class="cm-variable">val</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">dst_row</span>);  <span class="cm-comment">// 从核将信息 val 发送到同一列中第 dst_row 行</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">simd_putr</span>(<span class="cm-variable">simd_type</span> <span class="cm-variable">val</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">dst_col</span>);  <span class="cm-comment">// 从核将信息 val 发送到同一行中第 dst_col 列</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>其中，<code>simd_type</code>  为 SWCC 支持的 SIMD 扩展数据类型；<code>dst_col</code>  和 <code>dst_row</code>  设为 8 的时候即为全行 / 全列广播模式；<code>simd_getc</code>  和 <code>simd_putc</code>  需要通过返回值来更新变量的值，即正确的写法是 <code>recv_val = simd_getc(recv_val);</code> 。用这四个宏，我们可以写出如下的广播和点对点通信函数。假设我们传输的是 doublev4 类型。</p><p>广播函数：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">slave_bcast</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">int</span> <span class="cm-variable">my_id</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span> <span class="cm-variable">src</span>, <span class="cm-variable">doublev4</span> <span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span>)</span></pre></div><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">src_col</span> <span class="cm-operator">=</span> <span class="cm-variable">src</span> <span class="cm-operator">%</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">src_row</span> <span class="cm-operator">=</span> <span class="cm-variable">src</span> <span class="cm-operator">/</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">dst_col</span> <span class="cm-operator">=</span> <span class="cm-number">0x08</span>;  <span class="cm-comment">// 8 = 本列进行广播</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">dst_row</span> <span class="cm-operator">=</span> <span class="cm-number">0x08</span>;  <span class="cm-comment">// 8 = 本行进行广播</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">my_id</span> <span class="cm-operator">/</span> <span class="cm-number">8</span> <span class="cm-operator">==</span> <span class="cm-variable">src_row</span>) <span class="cm-comment">// 将 src 的数据广播到 src 所在的列，其余列的广播其实是没有用的</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">simd_putc</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span>, <span class="cm-variable">dst_col</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>} <span class="cm-keyword">else</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span> <span class="cm-operator">=</span> <span class="cm-variable">simd_getc</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">my_id</span> <span class="cm-operator">%</span> <span class="cm-number">8</span> <span class="cm-operator">==</span> <span class="cm-variable">src_col</span>) <span class="cm-comment">// 每一行的第 src_col 个从核已经拿到 src 的数据，广播到行内其他从核</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">simd_putr</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span>, <span class="cm-variable">dst_row</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>} <span class="cm-keyword">else</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span> <span class="cm-operator">=</span> <span class="cm-variable">simd_getr</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_bcast</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 485px;"></div></div></div></pre><p>点对点函数：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">slave_p2p</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">int</span> <span class="cm-variable">my_id</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span> <span class="cm-variable">src</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span> <span class="cm-variable">dst</span>, <span class="cm-variable">doublev4</span> <span class="cm-operator">*</span><span class="cm-variable">v4_p2p</span>)</span></pre></div><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">src</span> <span class="cm-operator">==</span> <span class="cm-variable">dst</span>) <span class="cm-keyword">return</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">src_col</span> <span class="cm-operator">=</span> <span class="cm-variable">src</span> <span class="cm-operator">%</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">dst_col</span> <span class="cm-operator">=</span> <span class="cm-variable">dst</span> <span class="cm-operator">%</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">dst_row</span> <span class="cm-operator">=</span> <span class="cm-variable">dst</span> <span class="cm-operator">/</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">my_col</span>  <span class="cm-operator">=</span> <span class="cm-variable">my_id</span> <span class="cm-operator">%</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">my_row</span>  <span class="cm-operator">=</span> <span class="cm-variable">my_id</span> <span class="cm-operator">/</span> <span class="cm-number">8</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">doublev4</span> <span class="cm-variable">tmp</span>;  <span class="cm-comment">// 用于中转，避免污染中转从核的数据</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// 将数据发送到与 src 在同一列、与 dst 在同一行的中转从核上</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">my_id</span> <span class="cm-operator">==</span> <span class="cm-variable">src</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">simd_putc</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_p2p</span>, <span class="cm-variable">dst_row</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> ((<span class="cm-variable">my_col</span> <span class="cm-operator">==</span> <span class="cm-variable">src_col</span>) <span class="cm-operator">&amp;&amp;</span> (<span class="cm-variable">my_row</span> <span class="cm-operator">==</span> <span class="cm-variable">dst_row</span>))</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">tmp</span> <span class="cm-operator">=</span> <span class="cm-variable">simd_getc</span>(<span class="cm-variable">tmp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">dst_col</span> <span class="cm-operator">==</span> <span class="cm-variable">src_col</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">my_id</span> <span class="cm-operator">==</span> <span class="cm-variable">dst</span>) <span class="cm-operator">*</span><span class="cm-variable">v4_p2p</span> <span class="cm-operator">=</span> <span class="cm-variable">tmp</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// 将数据从与 src 在同一列、与 dst 在同一行的中转从核上发送到 dst</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> ((<span class="cm-variable">my_col</span> <span class="cm-operator">==</span> <span class="cm-variable">src_col</span>) <span class="cm-operator">&amp;&amp;</span> (<span class="cm-variable">my_row</span> <span class="cm-operator">==</span> <span class="cm-variable">dst_row</span>))</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">simd_putr</span>(<span class="cm-variable">tmp</span>, <span class="cm-variable">dst_col</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">my_id</span> <span class="cm-operator">==</span> <span class="cm-variable">dst</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-operator">*</span><span class="cm-variable">v4_p2p</span> <span class="cm-operator">=</span> <span class="cm-variable">simd_getr</span>(<span class="cm-operator">*</span><span class="cm-variable">v4_p2p</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 670px;"></div></div></div></pre><p>注意，这两个函数不是直接被主核端程序调用的，而是在从核端的程序里来进行调用。样例代码请参见 <code>./demo_bcast</code> 文件夹。</p><h3><a name='header-c132' class='md-header-anchor '></a>Fortran + C 混合编程</h3><p>假设我们原来有如下的 Fortran90 代码：</p><pre class="md-fences md-end-block" lang="fortran"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">program main</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  implicit none</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  real*8 :: arr(64000)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  call doge(arr)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  print *, arr(1), arr(1001), arr(63001)</span></pre><pre class=""><span style="padding-right: 0.1px;">end</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">subroutine doge(arr)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  implicit none</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  real*8 :: arr(64000)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  integer :: i</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  do i = 1, 64000</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  arr(i) = i</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  end do</span></pre><pre class=""><span style="padding-right: 0.1px;">end subroutine doge</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p>我们的目标是将 subroutine doge 用 C 实现，并且利用上从核的计算能力。这一样例代码及其 Makefile 请参见 <code>./demo_fort_c_hybrid</code> 文件夹。其他 Fortran + C/C++ 混合编程的注意事项，请参考网络资料。</p><h2><a name='header-c138' class='md-header-anchor '></a>主从核数据传输</h2><p>建议使用 DMA (Direct Memory Access) 模式进行主核-从核的数据交互。SWCC 在这个框架下定义了一些函数接口，只能够从从核调用。目前，已经尝试出来的模式有 PE_MODE, BCAST_MODE, RANK_MODE。</p><h3><a name='header-c141' class='md-header-anchor '></a>使用 athread 封装过的 DMA 函数</h3><p>最简单的使用 DMA 的模式是在从核上使用 <code>athread_get()</code> 和 <code>athread_put()</code> 函数。这两个函数的接口定义如下：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">extern</span> <span class="cm-variable-3">int</span> <span class="cm-def">athread_get</span>(<span class="cm-variable">dma_mode</span> <span class="cm-variable">mode</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">src</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">dest</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">len</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">reply</span>, <span class="cm-variable-3">char</span> <span class="cm-variable">mask</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">stride</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">bsize</span>); <span class="cm-comment">// 拷贝主核 DDR 数据到从核 SPM</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">athread_put</span>(<span class="cm-variable">dma_mode</span> <span class="cm-variable">mode</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">src</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">dest</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">len</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">reply</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">stride</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">bsize</span>);  <span class="cm-comment">// 拷贝从核 SPM 数据到主核 DDR</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>这些参数具体的含义和选项请参见《基础语言编程手册》。这里重点讲一下第 5 个参数的作用。《基础语言编程手册》指出 DMA 操作是异步操作，但是在 <code>athread_get()</code> 和 <code>athread_put()</code> 函数的样例代码里漏了一点：如何知道异步操作已完成。《神威太湖之光系统快速使用指南》的样例代码里露出了马脚，经摸索，我们发现实际上是可以通过检查 <code>reply</code> 的值变化来确定。</p><p>每一次调用的  <code>athread_get()</code> 和 <code>athread_put()</code> 完成数据传输以后，会对传入的 <code>reply</code>  进行 +1 操作。所以使用这两个函数的代码应该如下：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">__thread_local</span> <span class="cm-keyword">volatile</span> <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">get_reply</span>, <span class="cm-variable">put_reply</span>; <span class="cm-comment">// 按要求，必须是在函数体外定义的 __thread_local volatile unsigned long 类型</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">func</span>(<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">param</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">get_reply</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">athread_get</span>(<span class="cm-variable">PE_MODE</span>, <span class="cm-variable">host_addr0</span>, <span class="cm-variable">ldm_addr0</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">ldm_addr</span>[<span class="cm-number">0</span>]) <span class="cm-operator">*</span> <span class="cm-variable">len</span>, (<span class="cm-variable-3">void*</span>)(<span class="cm-operator">&amp;</span><span class="cm-variable">get_reply</span>), <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">get_reply</span> <span class="cm-operator">!=</span> <span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">set_reply</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">athread_put</span>(<span class="cm-variable">PE_MODE</span>, <span class="cm-variable">ldm_addr1</span>, <span class="cm-variable">host_addr1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">ldm_addr</span>[<span class="cm-number">0</span>]) <span class="cm-operator">*</span> <span class="cm-variable">len</span>, (<span class="cm-variable-3">void*</span>)(<span class="cm-operator">&amp;</span><span class="cm-variable">put_reply</span>), <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">athread_put</span>(<span class="cm-variable">PE_MODE</span>, <span class="cm-variable">ldm_addr2</span>, <span class="cm-variable">host_addr2</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">ldm_addr</span>[<span class="cm-number">0</span>]) <span class="cm-operator">*</span> <span class="cm-variable">len</span>, (<span class="cm-variable-3">void*</span>)(<span class="cm-operator">&amp;</span><span class="cm-variable">put_reply</span>), <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">put_reply</span> <span class="cm-operator">!=</span> <span class="cm-number">2</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// other codes</span></span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 434px;"></div></div></div></pre><p>上面的代码的作用是：
(1) 将主核的 host_addr0 指向的内存传输到本 athread 中 ldm_addr0 指向的地方； 
(2) 等待 (1) 的传输完成；
(3) 将本 athread 中 ldm_addr1 指向的内存传输到主核的 host_addr1 指向的地方；
(4) 将本 athread 中 ldm_addr2 指向的内存传输到主核的 host_addr2 指向的地方；
(5) 等待 (3) (4) 的传输完成。</p><h3><a name='header-c157' class='md-header-anchor '></a>使用原生 DMA 函数（DMA instrinsic）</h3><p><code>athread_get()</code> 和 <code>athread_put()</code> 本质上是对 DMA 函数的一个包装，速度不如原生 DMA 函数。使用原生 DMA 函数需要先 <code>#include &lt;dma.h&gt;</code>下面是几个经过实验的 DMA 函数及其作用。</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_desc</span> <span class="cm-variable">dmad_put</span>;</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_op</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-variable">DMA_PUT</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mode</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-variable">PE_MODE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_size</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_reply</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dma_reply</span>); <span class="cm-comment">//dma_reply should be __thread_local volatile int</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma</span>(<span class="cm-variable">dmad_put</span>, <span class="cm-variable">host_global_ptr1</span>, <span class="cm-variable">thread_local_ptr1</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p>这一段代码的执行结果是将本 athread 的 thread_local_ptr1 指向的 80B 数据传输到主核的 host_global_ptr1 指向的地方。</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_desc</span> <span class="cm-variable">dmad_get</span>;</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_op</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_get</span>, <span class="cm-variable">DMA_GET</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mode</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_get</span>, <span class="cm-variable">PE_MODE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_size</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_get</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_reply</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_get</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dma_reply</span>); <span class="cm-comment">//dma_reply should be __thread_local volatile int</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma</span>(<span class="cm-variable">dmad_get</span>, <span class="cm-variable">host_global_ptr2</span>, <span class="cm-variable">thread_local_ptr2</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p>这一段代码的执行结果就是将主核的 host_global_ptr2 指向的 80B 数据传输到本 athread 的 thread_local_ptr2 指向的地方。</p><p>PE_MODE 是单从核模式，在此模式下，给个DMA指令只会影响到单个从核。</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_desc</span> <span class="cm-variable">dmad_bcast</span>;</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">long</span> <span class="cm-variable">dma_mask</span> <span class="cm-operator">=</span> <span class="cm-number">0xFFFFFFFFFFFFFFED</span>; &nbsp; <span class="cm-comment">//low 8 bit effective. ED = 11101101, so row 3 and 6 are not broadcasted</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_op</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_bcast</span>, <span class="cm-variable">DMA_GET</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mode</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_bcast</span>, <span class="cm-variable">BCAST_MODE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_size</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_bcast</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_reply</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_bcast</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dma_reply</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mask</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_bcast</span>, <span class="cm-variable">dma_mask</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma</span>(<span class="cm-variable">dmad_bcast</span>, <span class="cm-variable">host_global_ptr3</span>, <span class="cm-variable">thread_local_ptr3</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p>这一段代码的执行结果是将主核的 host_global_ptr3 指向的 80B 数据广播传输传输到除了行 3 和行 6 的所有 athread 的 thread_local_ptr3 指向的地方。</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_desc</span> <span class="cm-variable">dmad_rank</span>;</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_op</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-variable">DMA_GET</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mode</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-variable">RANK_MODE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_size</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">48</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_reply</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dma_bcast_reply</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_stepsize</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_bsize</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_rank</span>, <span class="cm-number">8</span> <span class="cm-operator">*</span> <span class="cm-number">4</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma</span>(<span class="cm-variable">dmad_rank</span>, <span class="cm-variable">host_global_ptr4</span>, <span class="cm-variable">thread_local_ptr4</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>从主核的 host_global_ptr4 指向的地方每隔 16bit 取 32bit 数据，并且每块 32bit 的数据都循环地落在 DMA 发起者所在行的 thread_local_ptr4 指向的地方。假设 dmad_rank 的发起者是 id = 9 的 athread，指针类型是 double，host_global_ptr4[i] = 1.0 * i，那么最后的结果将会是如下：
<img src='./images/DMA_rank.png' alt='DMA Rank Operation' /></p><p>DMA 在内存都是 128 Byte 对齐的时候，且传输量是 128 Byte 的倍数的时候，效率是最高的。</p><p>经测试，所有的 athread 都能够通过 DMA 正确且稳定地从主核那边读取内存，但是只有线程 0 地第 0 条 athread 能够相对稳定地通过 DMA 向主核写内存。经过测试，一个可能的原因是：如果 DMA 流水线中地最后一个 DMA 命令不是 athread_id = 0 的从核发出的话，那么流水线前面未执行的 DMA 的 put 命令会全部丢失。因此，有一个很 naive 的方法来避免这个问题：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">total_mask</span> <span class="cm-operator">=</span> <span class="cm-number">0xFFFFFFFF</span>;  <span class="cm-comment">// low 16 bit effective</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">athread_syn</span>(<span class="cm-variable">ARRAY_SCOPE</span>, <span class="cm-variable">total_mask</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">lpc</span> <span class="cm-operator">=</span> <span class="cm-number">128</span> <span class="cm-variable">–</span> <span class="cm-variable">my_id</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1000</span> <span class="cm-operator">*</span> <span class="cm-variable">lpc</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">for</span>(<span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">j</span> <span class="cm-operator">&lt;</span> <span class="cm-number">100</span>; <span class="cm-variable">j</span><span class="cm-operator">++</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">trump</span>[<span class="cm-variable">trump</span>[<span class="cm-variable">k</span>]];</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">c_slave</span>[<span class="cm-number">1000</span>] <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">*</span> <span class="cm-number">1.0</span>; &nbsp; &nbsp; &nbsp; <span class="cm-comment">// preventing compiler optimization</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_op</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-variable">DMA_PUT</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_mode</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-variable">PE_MODE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_size</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-number">1000</span> <span class="cm-operator">*</span> <span class="cm-number">8</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma_set_reply</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">dmad_put</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dma_reply</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">dma</span>(<span class="cm-variable">dmad_put</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">c</span>[<span class="cm-number">0</span>][<span class="cm-variable">my_id</span>][<span class="cm-number">0</span>], <span class="cm-operator">&amp;</span><span class="cm-variable">c_slave</span>[<span class="cm-number">0</span>]);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 270px;"></div></div></div></pre><p>上面的代码首先同步所有从核，然后通过一个 pointer chasing 来消耗时间，且线程号越小消耗的时间越多。这样，线程号越大就越早调用DMA_PUT，从而不会导致数据丢失。</p><h3><a name='header-c182' class='md-header-anchor '></a>同节点不同 MPI 进程 DMA 内存互读</h3><p>在运行参数是 <code>bsub -I -b -q q_sw_expr -N 2 -cross -np 4 -cgsp 64 -share_size 4096 -host_stack 128 ./test</code> 的时候，8 个 MPI 进程在 2 个节点上进行，意味着每 4 个 MPI 进程在 1 个节点上，它们理论上可以通过物理地址来相互拷贝内存。当然，操作系统存在的意义就是为了让我们避免这么干，但如果我们偏要这么干呢？athread的模式里面有 <code>DMA_GET_P</code> 和 <code>DMA_PUT_P</code> ，借助地址转换函数，我们可以让程序读取同节点内其他 MPI 进程的内存。</p><p>有两个相近的样例程序： <code>./demo_mpi/</code>  和 <code>./demo_mpi_getp/</code> ，后者展现了 <code>DMA_GET_P</code>  的使用。两者的区别如下。后者先通过 <code>uintptr_t vtop(uintptr_t vaddr)</code> 函数来将虚拟地址转换为物理地址，然后保存在 <code>host.c</code> 的 <code>a_paddr</code> 变量中。随后，rank 为 2k 和 2k+1 的进程通过 <code>MPI_Sendrecv</code> 交换 <code>a_paddr</code> 的值，从核通过这个交换后的地址读取对方进程的数据，然后再进行操作。</p><h3><a name='header-c187' class='md-header-anchor '></a>一个节点一个 MPI 进程使用四个核组</h3><p>要在每一个节点内只运行一个 MPI 进城并使用全部四个核组及其 MPE，需要在提交作业的命令中使用 <code>-cross</code>  参数。程序使用四个核组的时候，应该先创建 3 条 pthread 线程，然后与本进城一起进行 <code>athread_spawn()</code> ，系统会自动绑定线程到不同的核组上面。注意，不能创建 4 条 pthread 线程然后用创建的线程来进行 <code>athread_spawn()</code> ，这样会在运行的时候报错。一个样例程序是 <code>./demo_4cg_vec_add</code> ，运行在一个节点上，每一条 athread 将为自己对应的 <code>TN</code> 个 doublev4 加上自己所在的核组编号。</p><p>值得一提是的，在测试的时候，我们发现，从核函数中使用的单个变量，如果没有加上 <code>volatile</code> 关键字，可能在 <code>-O2</code> 或更高级的优化中得到错误的结果。一个例子是<code>./demo_4cg_vec_add/single_variable</code> ，里面 <code>slave.c</code> 第 18 行是否用 <code>volatile</code> 关键字会得到不同的结果。</p><h2><a name='header-c192' class='md-header-anchor '></a>使用向量化功能</h2><h3><a name='header-c193' class='md-header-anchor '></a>概要</h3><p>SW26010 的 CPE MPE 都拥有 256 位的向量部件，支持以下四种 SIMD 操作：</p><ul><li>32 bit * 8 的一次操作 8 个 32 位整数的定点运算</li><li>256 bit * 1 的一次操作 1 个 256 位长整形的定点运算</li><li>64 bit * 4 的一次操作 4 个单精度浮点数运算</li><li>64 bit * 4 的一次操作 4 个双精度浮点数运算</li></ul><p>对 SW26010 主核来说，定点的指令集不是完备的，例如 32 * 8 向量不包含乘法、除法等运算；256 * 1 向量不包含普通的算术运算，仅支持逻辑、移位等操作，因此，含有这些运算的程序难以使用 SIMD 提高性能；对 SW26010 从核同样有相应的限制。</p><p>使用 SIMD 功能需要在源代码文件中 <code>#include &lt;simd.h&gt;</code>，并且在编译和链接时使用 <code>-msimd</code> 参数。</p><h3><a name='header-c213' class='md-header-anchor '></a>使用内部扩展类型和函数</h3><p>当前的 SWCC 编译器 <strong>不支持编译器自动检测并进行向量化，也不支持使用引导语句（#pragma）提示编译器进行向量化</strong>。因此，要使用 SIMD 操作，只有一个选择：使用 SWCC 扩展支持的 SIMD 数据类型和函数。（其实还有另一个选择，就是直接写汇编，但是你不会想这么做的。）</p><p>常用的数据扩展类型有这几个：<code>doublev4</code>  <code>floatv4</code>  <code>intv8</code>  <code>uintv8</code>  <code>int256</code>  <code>uint256</code> 。SWCC 为这些类型定义了它们各自的输出函数以供调试使用： <code>simd_&lt;TYPE&gt;_print()</code> 。</p><p>上面提到的几个 SIMD 数据类型中的前 4 种，有两种容易混淆的常见的赋值方式：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">doublev4</span> <span class="cm-variable">v4alpha</span> <span class="cm-operator">=</span> <span class="cm-number">4.0</span>; &nbsp;  <span class="cm-comment">// sime_doublev4_print(v4alpha) 输出 [4.0, 4.0, 4.0, 4.0]</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">doublev4</span> <span class="cm-variable">v4beta</span>  <span class="cm-operator">=</span> {<span class="cm-number">1.0</span>};  <span class="cm-comment">// sime_doublev4_print(v4beta)  输出 [0.0, 0.0, 0.0, 1.0]，即 v4beta 的低 64 位被赋值成了 1.0</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>如果想初始化一个 SIMD 扩展类型的各个值为不同的，可以用如下方式：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">intv8</span> <span class="cm-variable">va</span> <span class="cm-operator">=</span> <span class="cm-variable">simd_set_intv8</span>(<span class="cm-number">1</span>, <span class="cm-number">2</span>, <span class="cm-number">3</span>, <span class="cm-number">4</span>, <span class="cm-number">5</span>, <span class="cm-number">6</span>, <span class="cm-number">7</span>, <span class="cm-number">8</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>此时在 va 的内存地址中，从低位到高位依次存放了 1 ~ 8 这 8 个 int。</p><p>SIMD 扩展数据类型也可以和标准数据类型进行交互。最好的方法是使用指针：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// x 是一个 double*</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">doublev4</span> <span class="cm-operator">*</span><span class="cm-variable">v4x</span> <span class="cm-operator">=</span> <span class="cm-operator">&amp;</span>(<span class="cm-variable">x</span>[<span class="cm-number">0</span>]); <span class="cm-comment">// 注意，x[0] 的地址需要满足下文所提到的内存对界需求，否则会出错</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">N</span> <span class="cm-operator">/</span> <span class="cm-number">4</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">v4x</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> ...</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>也可以显式使用 <code>simd_load()</code> 和 <code>simd_store()</code> 宏：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// x 是一个 double*</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">doublev4</span> <span class="cm-variable">v4x</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">mod4end</span> <span class="cm-operator">=</span> <span class="cm-variable">N</span> <span class="cm-operator">/</span> <span class="cm-number">4</span> <span class="cm-operator">*</span> <span class="cm-number">4</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">mod4end</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">simd_load</span>(<span class="cm-variable">v4x</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">x</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// 对 v4x 进行操作</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">simd_store</span>(<span class="cm-variable">v4x</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">x</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p> 一个简单的 SIMD 向量加法 Demo 在 <code>./demo_vec_add</code> 文件夹中。</p><p>下面是 SW26010 向量化主要功能表：</p><table><thead><tr><th>描述</th><th>调用</th></tr></thead><tbody><tr><td>doublev4加法</td><td>+</td></tr><tr><td>doublev4减法</td><td>-</td></tr><tr><td>doublev4乘法</td><td>*</td></tr><tr><td>doublev4除法</td><td>/</td></tr><tr><td>doublev4乘加</td><td>va * vb + vc 或者 (doublev4)__builtin_sw64_vmad(va, vb,  vc)</td></tr><tr><td>doublev4乘减</td><td>va * vb - vc 或者 (doublev4)__builtin_sw64_vmsd(va, vb,  vc)</td></tr><tr><td>doublev4负乘加</td><td>-va * vb + vc 或者 (doublev4)__builtin_sw64_vnmad(va, vb,  vc)</td></tr><tr><td>doublev4负乘减</td><td>-va * vb - vc 或者 (doublev4)__builtin_sw64_vnmsd(va, vb,  vc)</td></tr><tr><td>doublev4开方</td><td>__builtin_sw64_dlsqrt(va)</td></tr><tr><td>doublev4绝对值*</td><td>__builtin_sw64_vabsd(va)</td></tr><tr><td>doublev4条件选择eq</td><td>__builtin_sw64_sleq(va,  vb, vc)</td></tr><tr><td>doublev4条件选择lt</td><td>__builtin_sw64_sllt(va,  vb, vc)</td></tr><tr><td>doublev4条件选择le</td><td>__builtin_sw64_elles(va,  vb, vc)</td></tr><tr><td>doublev4条件选择ne</td><td>__builtin_sw64_slne(va,  vb, vc)</td></tr><tr><td>doublev4条件选择gt</td><td>__builtin_sw64_selgt(va,  vb, vc)</td></tr><tr><td>doublev4条件选择ge</td><td>__builtin_sw64_sellge(va,  vb, vc)</td></tr><tr><td>doublev4比较eq</td><td>__builtin_sw64_fcmpeq(va,  vb)</td></tr><tr><td>doublev4比较le</td><td>__builtin_sw64_lefcmp(va,  vb)</td></tr><tr><td>doublev4比较lt</td><td>__builtin_sw64_tlpmcf(va,  vb)</td></tr><tr><td>doublev4比较un</td><td>__builtin_sw64_fcmpun(va,  vb)</td></tr><tr><td>doublev4符号拷贝</td><td>__builtin_sw64_sypc(va,  vb)</td></tr><tr><td>doublev4符号反码拷贝</td><td>__builtin_sw64_cpysn(va,  vb)</td></tr><tr><td>doublev4符号指数拷贝</td><td>__builtin_sw64_esypc(va,  vb)</td></tr><tr><td>floatv4加法</td><td>+</td></tr><tr><td>floatv4减法</td><td>-</td></tr><tr><td>floatv4乘法</td><td>*</td></tr><tr><td>floatv4除法</td><td>/</td></tr><tr><td>floatv4乘加</td><td>va * vb + vc 或者 (floatv4)__builtin_sw64_vmas(va, vb,  vc)</td></tr><tr><td>floatv4乘减</td><td>va * vb - vc 或者 (floatv4)__builtin_sw64_vmss(va, vb,  vc)</td></tr><tr><td>floatv4负乘加</td><td>-va * vb + vc 或者 (floatv4)__builtin_sw64_vnmas(va, vb,  vc)</td></tr><tr><td>floatv4负乘减</td><td>-va * vb - vc 或者 (floatv4)__builtin_sw64_vnmss(va, vb,  vc)</td></tr><tr><td>floatv4开方</td><td>__builtin_sw64_sgqrts(va)    floatv4绝对值*</td></tr><tr><td>floatv4绝对值*</td><td>__builtin_sw64_vabss(va)</td></tr><tr><td>floatv4条件选择eq</td><td>__builtin_sw64_sleq(va,  vb, vc)</td></tr><tr><td>floatv4条件选择lt</td><td>__builtin_sw64_sllt(va,  vb, vc)</td></tr><tr><td>floatv4条件选择le</td><td>__builtin_sw64_elles(va,  vb, vc)</td></tr><tr><td>floatv4条件选择ne</td><td>__builtin_sw64_slne(va,  vb, vc)</td></tr><tr><td>floatv4条件选择gt</td><td>__builtin_sw64_selgt(va,  vb, vc)</td></tr><tr><td>floatv4条件选择ge</td><td>__builtin_sw64_sellge(va,  vb, vc)</td></tr><tr><td>floatv4比较eq</td><td>__builtin_sw64_fcmpeq(va,  vb)</td></tr><tr><td>floatv4比较le</td><td>__builtin_sw64_lefcmp(va,  vb)</td></tr><tr><td>floatv4比较lt</td><td>__builtin_sw64_tlpmcf(va,  vb)</td></tr><tr><td>floatv4比较un</td><td>__builtin_sw64_fcmpun(va,  vb)</td></tr><tr><td>floatv4符号拷贝</td><td>__builtin_sw64_sypc(va,  vb)</td></tr><tr><td>floatv4符号反码拷贝</td><td>__builtin_sw64_cpysn(va,  vb)</td></tr><tr><td>floatv4符号指数拷贝</td><td>__builtin_sw64_esypc(va,  vb)</td></tr><tr><td>intv8加法</td><td>(intv8)__builtin_sw64_vaddw(va,  vb)</td></tr><tr><td>intv8减法</td><td>(intv8)__builtin_sw64_vsubw(va,  vb)</td></tr><tr><td>intv8与</td><td>(intv8)__builtin_sw64_vandw(va,  vb)</td></tr><tr><td>intv8与非</td><td>(intv8)__builtin_sw64_vbicw(va,  vb)</td></tr><tr><td>intv8或</td><td>(intv8)__builtin_sw64_vorw(va,  vb)</td></tr><tr><td>intv8或非</td><td>(intv8)__builtin_sw64_vornotw(va,  vb)</td></tr><tr><td>intv8异或</td><td>(intv8)__builtin_sw64_vxorw(va,  vb)</td></tr><tr><td>intv8等效</td><td>(intv8)__builtin_sw64_veqvw(va,  vb)</td></tr><tr><td>intv8循环左移</td><td>__builtin_sw64_vrolw(va,  vb)  (不可用)</td></tr><tr><td>intv8左移</td><td>(intv8)__builtin_sw64_vsllw(va,  vb)</td></tr><tr><td>intv8右移</td><td>(intv8)__builtin_sw64_vsrlw(va,  vb)</td></tr><tr><td>intv8算术右移</td><td>(intv8)__builtin_sw64_vsraw(va,  vb)</td></tr><tr><td>int256(longv4)加法</td><td>(int256)__builtin_sw64_vaddl2(va,  vb)</td></tr><tr><td>int256(longv4)减法</td><td>(int256)__builtin_sw64_vsubl2(va,  vb)</td></tr><tr><td>int256逻辑左移</td><td>(int256)__builtin_sw64_sllow(va,  vb)</td></tr><tr><td>int256逻辑右移</td><td>(int256)__builtin_sw64_srlow(va,  vb)</td></tr></tbody></table><h3><a name='header-c426' class='md-header-anchor '></a>内存对界（Alignment）</h3><p>SW26010 的 SIMD 操作要求数据在内存中要求 32 字节对界（64 * 4 单精度浮点要求 16 字节对界），不对界的向量访存会引起异常，然后由操作系统模拟，性能上有很大的降低。</p><p>如果使用固定大小的数组，可以使用如下方式进行对界：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// C 语言使用 __attribute__((aligned (align_size))) 进行对界设定，注意： align_size 必须为 2 的幂</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// 主核：</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">a</span>[<span class="cm-number">10</span>] <span class="cm-def">__attribute__</span> ((<span class="cm-variable">aligned</span> (<span class="cm-number">64</span>))); <span class="cm-comment">// 使得 a 数组首地址 64 字节对界</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// 从核：</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">__thread_local</span> <span class="cm-variable-3">int</span> <span class="cm-variable">a</span>[<span class="cm-number">10</span>] <span class="cm-def">__attribute__</span>((<span class="cm-variable">__aligned__</span>(<span class="cm-number">128</span>))) <span class="cm-comment">// 使得 a 数组首地址 64 字节对界</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p>《基础语言编程手册》指出：</p><blockquote><p>向量类型的数据项在内存中除了 floatv4 类型是 16 字节对界其余都是 32 字节对界。编译器保证用向量类型定义的变量在内存中是 32 字节（16 字节）对界的，编译器还保证所有类型数组的首地址是 32 字节对界的。</p></blockquote><p>因此，在主机端使用动态分配的内存的时候，都是 32 字节对界的，不需要手动进行对界设置。</p><p>测试显示，从核上使用如下分配方式可能导致对界失败：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">seg_size</span>  <span class="cm-operator">=</span> <span class="cm-variable">block_size</span>(<span class="cm-variable">param</span>.<span class="cm-variable">size</span>, <span class="cm-number">64</span>, <span class="cm-variable">my_id</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">double</span> <span class="cm-variable-3">*</span><span class="cm-variable">ldm_x</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">double*</span>) <span class="cm-variable">ldm_malloc</span>(<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">double</span>) <span class="cm-operator">*</span> <span class="cm-variable">seg_size</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">double</span> <span class="cm-variable-3">*</span><span class="cm-variable">ldm_y</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">double*</span>) <span class="cm-variable">ldm_malloc</span>(<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">double</span>) <span class="cm-operator">*</span> <span class="cm-variable">seg_size</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p>改成如下的代码以后可以保证对界的成功：</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">seg_size</span>  <span class="cm-operator">=</span> <span class="cm-variable">block_size</span>(<span class="cm-variable">param</span>.<span class="cm-variable">size</span>, <span class="cm-number">64</span>, <span class="cm-variable">my_id</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">pad4v_seg_size</span> <span class="cm-operator">=</span> ((<span class="cm-variable">seg_size</span> <span class="cm-operator">/</span> <span class="cm-number">4</span>) <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-number">4</span>;  <span class="cm-comment">// 或者 = ((seg_size &gt;&gt; 2) + 1) &lt;&lt; 2</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">double</span> <span class="cm-variable-3">*</span><span class="cm-variable">ldm_x</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">double*</span>) <span class="cm-variable">ldm_malloc</span>(<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">double</span>) <span class="cm-operator">*</span> <span class="cm-variable">pad4v_seg_size</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">double</span> <span class="cm-variable-3">*</span><span class="cm-variable">ldm_y</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">double*</span>) <span class="cm-variable">ldm_malloc</span>(<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">double</span>) <span class="cm-operator">*</span> <span class="cm-variable">seg_size</span>);  <span class="cm-comment">// 这里也使用 pad4v_seg_size 会更好</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p>可知在从核上，<code>ldm_malloc()</code> 不能保证数组的首地址是对界的，需要用户自己维持对界设置。</p><h2><a name='header-c447' class='md-header-anchor '></a>作业提交</h2><p>太湖之光默认提交的作业都是 MPI 作业，使用 <code>bsub</code> 来提交，不需要加上 <code>mpirun</code> 。好像不支持提交脚本</p><h3><a name='header-c450' class='md-header-anchor '></a>常用的作业参数</h3><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-b</td><td>指定从核栈位于 LDM</td></tr><tr><td>-I</td><td>提交交互式作业， 使作业输出在作业提交窗口，无该选项时为批式作业</td></tr><tr><td>-q <queue_name></td><td>提交到 <queue_name> 队列，<strong>必须提供</strong></td></tr><tr><td>-N</td><td>指定需要的节点个数</td></tr><tr><td>-n</td><td>指定需要的所有主核数</td></tr><tr><td>-np</td><td>指定每节点内使用的主核数</td></tr><tr><td>-cgsp <cgnum></td><td>指定每个 CG 内需要的从核个数，指定时该参数必须 &lt;=64 （一般使用 64）</td></tr><tr><td>-share_size <share_MB></td><td>指定核组共享空间大小（MB），一般最大可以到 7600</td></tr><tr><td>-host_stack <stack_MB></td><td>指定主核栈空间大小（MB），默认为 8，一般使用 128</td></tr><tr><td>-cross</td><td>要求分配全片 CPU（ 4CG 的 MPE）</td></tr><tr><td>-o <output_file></td><td>将作业的 stdout 和 stderr 的输出定向到 <output_file></td></tr></tbody></table><h3><a name='header-c488' class='md-header-anchor '></a>常用的提交命令组合</h3><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap   "><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 需要 8 个主核（一共 8 个 MPI 进程），每个主核对应一个 64 从核核组，8 个主核分配位置不确定</span></span></pre></div><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">bsub <span class="cm-attribute">-I</span> <span class="cm-attribute">-b</span> <span class="cm-attribute">-q</span> q_sw_expr <span class="cm-attribute">-n</span> <span class="cm-number">8</span> <span class="cm-attribute">-cgsp</span> <span class="cm-number">64</span> <span class="cm-attribute">-share_size</span> <span class="cm-number">7000</span> <span class="cm-attribute">-host_stack</span> <span class="cm-number">128</span> ./exefile</span></pre></div><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre></div><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 需要 2 个节点，每个节点 4 个主核（一共 8 个 MPI 进程），每个主核对应一个 64 从核核组</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">bsub <span class="cm-attribute">-I</span> <span class="cm-attribute">-b</span> <span class="cm-attribute">-q</span> q_sw_expr <span class="cm-attribute">-N</span> <span class="cm-number">2</span> <span class="cm-attribute">-cross</span> <span class="cm-attribute">-np</span> <span class="cm-number">4</span> <span class="cm-attribute">-cgsp</span> <span class="cm-number">64</span> <span class="cm-attribute">-share_size</span> <span class="cm-number">7000</span> <span class="cm-attribute">-host_stack</span> <span class="cm-number">128</span> ./test</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 需要 2 个节点，每个节点使用 1 个主核（一共 2 个 MPI 进程），每个主核可以创建 4 条线程使用四个核组</span></span></pre><pre class=""><span style="padding-right: 0.1px;">bsub <span class="cm-attribute">-I</span> <span class="cm-attribute">-b</span> <span class="cm-attribute">-q</span> q_sw_expr <span class="cm-attribute">-N</span> <span class="cm-number">2</span> <span class="cm-attribute">-cross</span> <span class="cm-attribute">-np</span> <span class="cm-number">1</span> <span class="cm-attribute">-cgsp</span> <span class="cm-number">64</span> <span class="cm-attribute">-share_size</span> <span class="cm-number">7000</span> <span class="cm-attribute">-host_stack</span> <span class="cm-number">128</span> ./test</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p>目前还没有找到可以让一个节点内一个进程使用超过 8GB 内存的方法。《快速使用手册》上的全片共享模式目前会报错，原因未明。</p></div>
</body>
</html>